<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMASH WHO?</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2a2a40);
      color: #f5f5f5;
      text-align: center;
      margin: 0;
      padding: 20px;
      padding-bottom: 80px;
    }
    h1, h2 {
      color: #fff;
      text-shadow: 0 0 10px #ff00ff88;
      margin: 10px 0;
    }
    .tagline {
      font-size: 1.3em;
      color: #ccc;
      margin-top: -5px;
      margin-bottom: 15px;
      text-shadow: 0 0 5px #ff00ff55;
    }
    #vote-counter {
      font-size: 1.1em;
      margin-bottom: 5px;
      color: #ff00ff;
      font-weight: bold;
    }
    #reset-timer {
      font-size: 0.95em;
      color: #bbb;
      margin-bottom: 20px;
    }
    .choice-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .choice {
      background: rgba(30, 30, 47, 0.9);
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 0 10px #000;
      cursor: pointer;
      font-size: 1.5em;
      font-weight: bold;
      transition: transform 0.2s ease, background-color 0.2s ease;
      min-width: 140px;
      max-width: 90%;
    }
    .choice:hover { transform: scale(1.05); }
    button {
      padding: 14px 20px;
      border: none;
      background: #9b00ff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px;
      font-weight: bold;
      font-size: 1.1em;
    }
    .danger { background: #ff0044; }
    .sticky-bar {
      display: flex;
      gap: 8px;
    }
    @media (max-width: 600px) {
      .sticky-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(20, 20, 30, 0.8);
        padding: 8px;
        display: flex;
        gap: 8px;
      }
      .sticky-bar button { flex: 1; font-size: 0.95em; }
    }
    table {
      border-collapse: collapse;
      background: rgba(30, 30, 47, 0.9);
      border-radius: 10px;
      overflow: hidden;
      min-width: 300px;
      margin: auto;
      color: #fff;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th { color: #00f0ff; }
    .gold { background-color: rgba(255, 215, 0, 0.15); font-weight: bold; }
    .silver { background-color: rgba(192, 192, 192, 0.15); font-weight: bold; }
    .bronze { background-color: rgba(205, 127, 50, 0.15); font-weight: bold; }
    #rainCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
  </style>
</head>
<body>
  <canvas id="rainCanvas"></canvas>
  <h1>WHO THE BEST? üòçü•µ</h1>
  <p class="tagline">Welcome to duos ‚Äî an anonymous choosing app where players pick between two random apsites.</p>
  <div id="vote-counter">Votes left: 10/10</div>
  <div id="reset-timer">Next reset in: 3h 00m 00s</div>

  <div class="choice-container">
    <div class="choice" id="choice1"></div>
    <div class="choice" id="choice2"></div>
  </div>

  <div class="sticky-bar">
    <button onclick="skipRound()">Skip</button>
    <button onclick="suggestName()">Suggest Name</button>
  </div>

  <div id="online-count" style="font-size:1.1em; margin-bottom:10px; color:#00f0ff; font-weight:bold;">
    Anonymous users online: 0
  </div>

  <div id="leaderboard">
    <h2>Leaderboard</h2>
    <table>
      <thead><tr><th>Rank</th><th>Name</th><th>Votes</th></tr></thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <button class="danger" onclick="resetLeaderboard()">Reset Leaderboard</button>
  <button class="danger" onclick="resetAllVotes()">Reset All Votes</button>
  <button onclick="reviewSuggestions()">Review Suggestions</button>

  <div id="suggestions-panel" style="margin-top:20px;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, query, orderBy, onSnapshot, writeBatch, addDoc, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzDUM_vivcTLN7dGMKEeBYMFR5Wp4dKH8",
      authDomain: "boporbaddie.firebaseapp.com",
      projectId: "boporbaddie",
      storageBucket: "boporbaddie.firebasestorage.app",
      messagingSenderId: "32915423043",
      appId: "1:32915423043:web:8ecb3ced9d82e122dc79f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allPeople = [], currentChoices = [], lastChoices = [], userDocRef = null;

    function checkVoteReset() {
      let lastReset = parseInt(localStorage.getItem("lastVoteReset") || "0");
      let now = Date.now(), threeHours = 10800000;
      if (!lastReset || now - lastReset > threeHours) {
        localStorage.setItem("votesUsed", "0");
        localStorage.setItem("lastVoteReset", now.toString());
      }
    }
    function updateVoteCounter() {
      const used = parseInt(localStorage.getItem("votesUsed") || "0");
      document.getElementById("vote-counter").innerText = `Votes left: ${10 - used}/10`;
    }
    function updateResetTimer() {
      let lastReset = parseInt(localStorage.getItem("lastVoteReset") || "0");
      let diff = (lastReset + 10800000) - Date.now();
      let h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
      document.getElementById("reset-timer").innerText = `Next reset in: ${h}h ${m.toString().padStart(2,"0")}m ${s.toString().padStart(2,"0")}s`;
    }
    setInterval(updateResetTimer, 1000);

    async function checkGlobalVoteReset() {
      const ref = doc(db, "settings", "votesReset");
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const serverKey = snap.data().key;
        if (serverKey !== localStorage.getItem("votesResetKey")) {
          localStorage.setItem("votesUsed", "0");
          localStorage.setItem("lastVoteReset", Date.now().toString());
          localStorage.setItem("votesResetKey", serverKey);
        }
      }
    }
    async function resetAllVotes() {
      if (prompt("Enter admin reset code:") !== "secret123") return;
      const newKey = Date.now().toString();
      await setDoc(doc(db, "settings", "votesReset"), { key: newKey });
      alert("All votes reset!");
    }

    async function initScores() {
      const seed = ["Nidhi","Yachna","Poorvi","Liri","Eshanika","Diya","Aditi","Mehak"];
      for (let p of seed) {
        let r = doc(db, "leaderboard", p);
        if (!(await getDoc(r)).exists()) await setDoc(r, { name: p, votes: 0 });
      }
      checkVoteReset();
      await checkGlobalVoteReset();
      updateVoteCounter();
      joinPresence();
      listenOnlineUsers();
    }
    function updateLeaderboardLive() {
      const qy = query(collection(db, "leaderboard"), orderBy("votes", "desc"));
      onSnapshot(qy, snap => {
        let tbody = document.getElementById("leaderboard-body");
        tbody.innerHTML = "";
        let rank = 1;
        allPeople = [];
        snap.forEach(d => {
          let data = d.data();
          allPeople.push(data.name);
          let rowClass = "", medal = "";
          if (rank === 1) { rowClass = "gold"; medal = "ü•á "; }
          else if (rank === 2) { rowClass = "silver"; medal = "ü•à "; }
          else if (rank === 3) { rowClass = "bronze"; medal = "ü•â "; }
          tbody.innerHTML += `<tr class="${rowClass}"><td>${medal}${rank}</td><td>${data.name}</td><td>${data.votes}</td></tr>`;
          rank++;
        });
        if (!currentChoices.length) nextRound();
      });
    }

    function getRandomPerson(exclude = []) {
      let avail = allPeople.filter(p => !exclude.includes(p));
      return avail[Math.floor(Math.random() * avail.length)];
    }
    function nextRound() {
      if (allPeople.length < 2) return;
      let p1 = getRandomPerson(lastChoices);
      let p2 = getRandomPerson([...lastChoices, p1]);
      currentChoices = [p1, p2];
      lastChoices = [p1, p2];
      document.getElementById("choice1").innerText = p1;
      document.getElementById("choice2").innerText = p2;
    }
    async function pick(i) {
      let used = parseInt(localStorage.getItem("votesUsed") || "0");
      if (used >= 10) return alert("Vote limit reached. Wait for reset.");
      localStorage.setItem("votesUsed", used + 1);
      updateVoteCounter();
      await updateDoc(doc(db, "leaderboard", currentChoices[i]), { votes: increment(1) });
      nextRound();
    }
    function skipRound() {
      let used = parseInt(localStorage.getItem("votesUsed") || "0");
      if (used >= 10) {
        alert("Vote limit reached. Wait for reset.");
        return;
      }
      let newUsed = used + 2;
      if (newUsed > 10) newUsed = 10;
      localStorage.setItem("votesUsed", newUsed);
      updateVoteCounter();
      nextRound();
    }

    async function resetLeaderboard() {
      if (prompt("Enter admin reset code:") !== "secret123") return;
      const batch = writeBatch(db);
      allPeople.forEach(p => batch.update(doc(db, "leaderboard", p), { votes: 0 }));
      await batch.commit();
      alert("Leaderboard reset!");
    }

    async function suggestName() {
      const name = prompt("Enter name to suggest:");
      if (!name) return;
      await addDoc(collection(db, "suggestions"), { name: name.trim(), timestamp: serverTimestamp() });
      alert("Suggestion sent!");
    }

    async function reviewSuggestions() {
      if (prompt("Enter admin code:") !== "secret123") return;
      const panel = document.getElementById("suggestions-panel");
      panel.innerHTML = "<h3>Suggestions</h3>";

      const snap = await getDocs(collection(db, "suggestions"));
      if (snap.empty) {
        panel.innerHTML += "<p>No pending suggestions.</p>";
        return;
      }

      panel.innerHTML += `
        <div style="margin-bottom:10px;">
          <label><input type="checkbox" id="selectAllSuggestions"> Select All</label>
          <button onclick="approveSelectedSuggestions()">Approve Selected</button>
        </div>
      `;

      snap.forEach(d => {
        const n = d.data().name;
        panel.innerHTML += `
          <div>
            <label>
              <input type="checkbox" class="suggestionCheckbox" data-id="${d.id}" data-name="${n}">
              ${n}
            </label>
          </div>
        `;
      });

      document.getElementById("selectAllSuggestions").addEventListener("change", function() {
        const checkboxes = document.querySelectorAll(".suggestionCheckbox");
        checkboxes.forEach(cb => cb.checked = this.checked);
      });
    }

    async function approveSelectedSuggestions() {
      const selected = document.querySelectorAll(".suggestionCheckbox:checked");
      if (selected.length === 0) {
        alert("No suggestions selected.");
        return;
      }
      const batch = writeBatch(db);
      selected.forEach(cb => {
        const id = cb.getAttribute("data-id");
        const name = cb.getAttribute("data-name");
        batch.set(doc(db, "leaderboard", name), { name: name, votes: 0 });
        batch.delete(doc(db, "suggestions", id));
      });
      await batch.commit();
      alert(`Approved ${selected.length} suggestions!`);
      reviewSuggestions();
    }

    async function joinPresence() {
      let id = sessionStorage.getItem("presenceId");
      if (!id) {
        id = Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem("presenceId", id);
      }
      userDocRef = doc(db, "onlineUsers", id);
      await setDoc(userDocRef, { lastActive: serverTimestamp() });
      setInterval(async () => {
        await updateDoc(userDocRef, { lastActive: serverTimestamp() });
      }, 30000);
      window.addEventListener("beforeunload", async () => {
        await deleteDoc(userDocRef);
      });
    }

    function listenOnlineUsers() {
      onSnapshot(collection(db, "onlineUsers"), snap => {
        const now = Date.now();
        let count = 0;
        snap.forEach(d => {
          const data = d.data();
          if (data.lastActive?.toMillis && (now - data.lastActive.toMillis()) < 60000) count++;
        });
        document.getElementById("online-count").innerText = `Anonymous users online: ${count}`;
      });
    }

    // Expose functions globally for HTML buttons
    window.skipRound = skipRound;
    window.suggestName = suggestName;
    window.reviewSuggestions = reviewSuggestions;
    window.approveSelectedSuggestions = approveSelectedSuggestions;
    window.resetLeaderboard = resetLeaderboard;
    window.resetAllVotes = resetAllVotes;

    document.getElementById("choice1").onclick = () => pick(0);
    document.getElementById("choice2").onclick = () => pick(1);

    initScores().then(updateLeaderboardLive);
  </script>

  <script>
    const rainCanvas = document.getElementById("rainCanvas");
    const ctx = rainCanvas.getContext("2d");
    let width, height;
    function resizeCanvas() {
      width = rainCanvas.width = window.innerWidth;
      height = rainCanvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    class Raindrop {
      constructor() { this.reset(); }
      reset() {
        this.x = Math.random() * width;
        this.y = Math.random() * -height;
        this.length = Math.random() * 15 + 10;
        this.speed = Math.random() * 4 + 2;
        this.opacity = Math.random() * 0.2 + 0.1;
      }
      update() {
        this.y += this.speed;
        if (this.y > height) this.reset();
      }
      draw() {
        ctx.beginPath();
        ctx.strokeStyle = `rgba(200, 0, 255, ${this.opacity})`;
        ctx.lineWidth = 1.2;
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(this.x, this.y + this.length);
        ctx.shadowBlur = 8;
        ctx.shadowColor = "rgba(200, 0, 255, 0.6)";
        ctx.stroke();
      }
    }
    const drops = [];
    for (let i = 0; i < 120; i++) drops.push(new Raindrop());
    function animateRain() {
      ctx.clearRect(0, 0, width, height);
      drops.forEach(d => { d.update(); d.draw(); });
      requestAnimationFrame(animateRain);
    }
    animateRain();
  </script>
</body>
</html>
